# Оптимізація продуктивності

Мета цього розділу — допомогти запускати довгі симуляції ефективно та стабільно.

## Тимчасова дискретизація
- Рекомендовані кроки: `dt = 1e-4` для високої точності, `dt = 5e-4` для швидких скринінгів.
- Забезпечуйте кратність тривалості симуляції кроку (`seconds % dt == 0`).

## Вибір ядра згортки
- Параметри `tau_rise`, `tau_decay` впливають на ширину ядра. Для подій <1 мс не опускайте `tau_rise` нижче 0.3 мс.
- При значеннях \(\tau_\text{rise} \approx \tau_\text{decay}\) використовуйте стабілізовану формулу (вмикається автоматично).

## FFT-поріг
- За замовчуванням: 16 384 зразків. Налаштовується через CLI `--fft-threshold` або конфіг `config.toml`.
- Для GPU-навантажень рекомендується знижувати поріг до 8k для збалансованості пам'яті та часу.

## Паралельність
- CLI-прапорець `--workers` дозволяє запускати кілька сценаріїв паралельно (multiprocessing).
- Для середовищ без fork (Windows) використовуйте `spawn` режим (`--start-method spawn`).

## Профілювання
```bash
neuromotorica profile --seconds 2.0 --rate 20 --report profile.json
```
- Звіт містить час на кожен етап (конволюція, фільтрація, інтеграція, force).
- Інтегрується з `snakeviz` та `py-spy`.

## Використання пам'яті
- Уникайте зберігання повних тимчасових матриць: використовуйте генератори серій.
- Для довгих симуляцій вмикайте стрімінг `--stream-output`, що пише результати chunk-ами.

## Налаштування Extended режиму
- Стохастична надійність додає випадкові шуми: збільшуйте розмір батча, щоб згладити варіації.
- Гліальний модуль (`--glial-gain`) повільніший: варто підвищити `dt` до 2e-4 для прискорення.

## CI-поради
- Автоматичні тести працюють зі скороченими сценаріями (<=0.5 с) для економії часу.
- Для локального підтвердження продуктивності використовуйте мітку `slow` (`pytest -m slow`).
