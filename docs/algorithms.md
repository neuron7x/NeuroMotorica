# Алгоритми симуляції

Описані нижче процедури відповідають за чисельну стабільність та продуктивність симулятора.

## 1. Конволюція спайків
- **Стабілізоване альфа-ядро**:
  \[ k(t) = \frac{t}{\tau_\text{decay} - \tau_\text{rise}} \left(e^{-t/\tau_\text{decay}} - e^{-t/\tau_\text{rise}}\right) \]
- Використовується нормалізація з перепараметризацією, що уникає втрати точності при \(\tau_\text{rise} \approx \tau_\text{decay}\).
- Генерація ядра кешується для повторного використання між симуляціями.

## 2. Адаптивна згортка
- **Eager режим**: `numpy.convolve` для коротких сигналів (до ~4×довжини ядра).
- **FFT режим**: автоматичне перемикання на FFT-згортку при довгих послідовностях (>16k зразків).
- Критерій переходу визначається емпірично й може бути переналаштований параметром CLI `--fft-threshold`.

## 3. Фільтрація
- **RC low-pass**: експоненційне згладжування для швидких попередніх оцінок.
- **Zero-phase biquad**: беззсувна фільтрація другого порядку, розгортається вперед-назад без залежності від SciPy.
- Коефіцієнти обчислюються за формулами RBJ з контролем чисельної стабільності (кліп діапазону Q, freq).

## 4. Нелінійна інтеграція ACh×Hist
- Сукупна активація обчислюється як зважена сума ACh та Hist із мультиплікативним перехресним терміном.
- Обмеження (clamping) проводиться в діапазоні [0, 1.5] для `EnhancedNMJ` та [0, 1.2] для `OptimizedEnhancedNMJ`.
- Нормалізація масштабу залежить від кількості активних моторних одиниць.

## 5. Моделювання сили м'яза
- Підсумовування внеску кожної MU з урахуванням її масштабу та часової дельти.
- Компоненти:
  - **Активна сила**: функція довжина–напруга та швидкість–напруга.
  - **Пасивна сила**: експоненційний компонент, що гарантує ненульову напругу при розтягненні.
- Результат використовується як вхід для модулів контролю протоколів.

## 6. Стохастика та патології
- Опціональний канал шуму моделюється як гаусів процес із масштабом `noise_sigma`.
- Для патологій (міастенія, ALS) модифікуються параметри вивільнення трансмітера та провідність мембрани.
- Вихідні дані включають метрики надійності (failure rate, jitter).

## 7. Продуктивність
- Векторизація через NumPy та `numexpr` (коли доступний).
- Пакетна обробка сценаріїв забезпечує GPU/TPU-сумісність за рахунок абстракції backend.
- Інструмент `neuromotorica profile` (див. CLI допомогу) збирає метрики часу виконання.
